---
import BottomNavigation from '@/components/BottomNavigation.tsx';
import TopNavigation from '@/components/TopNavigation.astro';
import DocumentMeta from './DocumentMeta.astro';

const {
  title,
  description,
  ogImage,
  showNavigation = true,
  showTopNavigation = showNavigation,
  showBottomNavigation = showNavigation,
} = Astro.props;
---

<!doctype html>
<html lang="zh-Hans">
  <head>
    <DocumentMeta title={title} description={description} ogImage={ogImage} />
    <slot name="head" />
  </head>
  <body class="bg-white dark:bg-zinc-900 dark:text-white min-h-dvh flex flex-col overflow-x-hidden">
    {showTopNavigation && <TopNavigation />}

    <main class:list={["flex-1 w-full"]}>
      <slot />
    </main>

    {showBottomNavigation && <BottomNavigation client:load />}

    <script async defer is:inline>
      function initCopyButtons() {
        const buttons = document.querySelectorAll('.copy-code');
        buttons.forEach((button) => {
          if (button.hasAttribute('data-initialized')) return;

          button.addEventListener('click', async () => {
            const pre = button.closest('pre');
            const code = pre?.querySelector('code');
            if (!code) return;

            try {
              await navigator.clipboard.writeText(code.innerText);
              button.textContent = '已复制!';
              button.classList.add('copied');
              setTimeout(() => {
                button.textContent = '复制';
                button.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('复制失败:', err);
            }
          });

          button.setAttribute('data-initialized', 'true');
        });
      }

      let lastScrollY = window.scrollY;
      let scrollListener = null;

      function initScrollNav() {
        const topNav = document.getElementById('top-nav');
        const tolerance = 5;

        if (scrollListener) {
          window.removeEventListener('scroll', scrollListener);
        }

        scrollListener = () => {
          const currentScrollY = window.scrollY;

          if (currentScrollY <= 100) {
            topNav?.classList.remove('-translate-y-full');
            lastScrollY = currentScrollY;
            return;
          }

          if (Math.abs(currentScrollY - lastScrollY) <= tolerance) {
            return;
          }

          if (currentScrollY > lastScrollY) {
            topNav?.classList.add('-translate-y-full');
          } else {
            topNav?.classList.remove('-translate-y-full');
          }
          lastScrollY = currentScrollY;
        };

        window.addEventListener('scroll', scrollListener, { passive: true });
      }

      initCopyButtons();
      initScrollNav();

      document.addEventListener('astro:after-swap', () => {
        initCopyButtons();
        initScrollNav();
      });
    </script>
  </body>
</html>
