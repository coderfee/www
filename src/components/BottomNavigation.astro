---
import ArchiveIcon from '~icons/tabler/archive';
import ArrowUpIcon from '~icons/tabler/arrow-up';
import BookIcon from '~icons/tabler/book-2';
import SmartHomeIcon from '~icons/tabler/smart-home';

const pathname = new URL(Astro.request.url).pathname;
const isActive = (path: string) => {
  if (path === '/' && pathname === path) return true;
  if (path !== '/' && pathname.startsWith(path)) return true;
  return false;
};

const navItems = [
  { name: '首页', path: '/', icon: SmartHomeIcon },
  { name: '归档', path: '/archive', icon: ArchiveIcon },
  { name: '周刊', path: '/newsletter', icon: BookIcon },
];
---

<div id="bottom-nav" class="md:hidden fixed bottom-2 left-1/2 -translate-x-1/2 z-50 pointer-events-none w-max">
  <nav
    class="pointer-events-auto bg-white/50 dark:bg-zinc-900/50 backdrop-blur-xl rounded-full border border-zinc-200/50 dark:border-zinc-800/50 shadow-[0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4)] p-1 mb-[env(safe-area-inset-bottom)] flex items-center select-none [touch-callout:none] [-webkit-touch-callout:none]"
  >
    <div class="flex items-center gap-1">
      {navItems.map((item) => (
        <a
          href={item.path}
          class:list={[
            'nav-tab flex flex-col items-center justify-center min-w-[80px] h-11 rounded-full transition-colors duration-300 relative overflow-hidden active:scale-90',
            isActive(item.path)
              ? 'text-zinc-900 dark:text-zinc-100'
              : 'text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100'
          ]}
          aria-current={isActive(item.path) ? 'page' : undefined}
          aria-label={item.name}
          title={item.name}
        >
          {isActive(item.path) && (
            <div
              class="absolute inset-0 bg-zinc-100 dark:bg-zinc-800 -z-10"
            />
          )}
          <item.icon class="w-5 h-5 mb-0.5" />
          <span class="text-[10px] font-medium leading-none">{item.name}</span>
        </a>
      ))}
    </div>

    <div id="back-to-top-container" class="flex items-center overflow-hidden w-0 opacity-0">
      <button
        id="back-to-top"
        class="flex flex-col items-center justify-center min-w-[48px] h-11 rounded-full text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 active:scale-90 cursor-pointer"
        aria-label="回到顶部"
      >
        <ArrowUpIcon class="w-5 h-5 mb-0.5" />
        <span class="text-[10px] font-medium leading-none">顶部</span>
      </button>
    </div>
  </nav>
</div>

<script>
  import { prefetch } from 'astro:prefetch';

  function initNavFeatures() {
    const nav = document.getElementById('bottom-nav');
    const container = document.getElementById('back-to-top-container');
    const btn = document.getElementById('back-to-top');

    if (!nav || !container || !btn) return;

    if (window.location.pathname === '/') {
      prefetch('/archive', { eagerness: 'moderate' });
      prefetch('/newsletter', { eagerness: 'moderate' });
    }

    nav.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('.nav-tab') || target.closest('#back-to-top')) {
        if ('vibrate' in navigator) navigator.vibrate(10);
      }
    });

    btn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const updateState = () => {
      if (window.scrollY > 300) {
        container.classList.remove('w-0', 'opacity-0');
        container.classList.add('w-[48px]', 'opacity-100');
      } else {
        container.classList.remove('w-[48px]', 'opacity-100');
        container.classList.add('w-0', 'opacity-0');
      }
    };

    updateState();

    void container.offsetWidth;

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        container.classList.add('transition-all', 'duration-500', 'ease-[cubic-bezier(0.32,0.72,0,1)]');
      });
    });

    window.addEventListener('scroll', updateState, { passive: true });

    setTimeout(() => {
      updateState();
    }, 100);
  }

  initNavFeatures();
  document.addEventListener('astro:after-swap', initNavFeatures);
</script>
