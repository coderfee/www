---
import ArchiveIcon from '~icons/tabler/archive';
import ArrowUpIcon from '~icons/tabler/arrow-up';
import BookIcon from '~icons/tabler/book-2';
import SmartHomeIcon from '~icons/tabler/smart-home';

const pathname = new URL(Astro.request.url).pathname;
const isActive = (path: string) => {
  if (path === '/' && pathname === path) return true;
  if (path !== '/' && pathname.startsWith(path)) return true;
  return false;
};

const navItems = [
  { name: '首页', path: '/', icon: SmartHomeIcon },
  { name: '归档', path: '/archive', icon: ArchiveIcon },
  { name: '周刊', path: '/newsletter', icon: BookIcon },
];
---

<div id="bottom-nav" class="md:hidden fixed bottom-2 left-1/2 -translate-x-1/2 z-50 pointer-events-none w-max">
  <nav
    class="pointer-events-auto bg-white/50 dark:bg-zinc-900/50 backdrop-blur-xl rounded-full border border-zinc-200/50 dark:border-zinc-800/50 shadow-[0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4)] p-1 mb-[env(safe-area-inset-bottom)] flex items-center select-none [touch-callout:none] [-webkit-touch-callout:none]"
  >
    <div class="flex items-center gap-1">
      {navItems.map((item) => (
        <a
          href={item.path}
          class:list={[
            'nav-tab flex flex-col items-center justify-center min-w-[80px] h-11 rounded-full transition-colors duration-300 relative overflow-hidden active:scale-90 hover:bg-zinc-100 dark:hover:bg-zinc-800',
            isActive(item.path)
              ? 'text-zinc-900 dark:text-zinc-100'
              : 'text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100'
          ]}
          aria-current={isActive(item.path) ? 'page' : undefined}
          aria-label={item.name}
          title={item.name}
        >
          {isActive(item.path) && (
            <div
              class="absolute inset-0 bg-zinc-100 dark:bg-zinc-800 -z-10"
            />
          )}
          <item.icon class="w-5 h-5 mb-0.5" />
          <span class="text-[10px] font-medium leading-none">{item.name}</span>
        </a>
      ))}
    </div>
  </nav>
</div>

<script>
  import { prefetch } from 'astro:prefetch';

  function initNavFeatures() {
    const nav = document.getElementById('bottom-nav');

    if (!nav) return;

    if (window.location.pathname === '/') {
      prefetch('/archive', { eagerness: 'moderate' });
      prefetch('/newsletter', { eagerness: 'moderate' });
    }

    nav.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('.nav-tab')) {
        if ('vibrate' in navigator) navigator.vibrate(10);
      }
    });
  }

  initNavFeatures();
  document.addEventListener('astro:after-swap', initNavFeatures);
</script>
