---
import ArchiveIcon from '~icons/tabler/archive';
import ArrowUpIcon from '~icons/tabler/arrow-up';
import BookIcon from '~icons/tabler/book-2';
import SmartHomeIcon from '~icons/tabler/smart-home';

const pathname = new URL(Astro.request.url).pathname;
const isActive = (path: string) => {
  if (path === '/' && pathname === path) return true;
  if (path !== '/' && pathname.startsWith(path)) return true;
  return false;
};

const navItems = [
  { name: '首页', path: '/', icon: SmartHomeIcon },
  { name: '归档', path: '/archive', icon: ArchiveIcon },
  { name: '周刊', path: '/newsletter', icon: BookIcon },
];
---

<div
  id="bottom-nav"
  class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50 transition-transform duration-300 pointer-events-none w-max flex items-center gap-3"
>
  <nav
    class="pointer-events-auto bg-white/50 dark:bg-zinc-900/50 backdrop-blur-xl rounded-full border border-zinc-200/50 dark:border-zinc-800/50 shadow-[0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4)] p-1 mb-[env(safe-area-inset-bottom)]"
  >
    <div class="flex items-center gap-1">
      {navItems.map((item) => (
        <a
          href={item.path}
          class:list={[
            'nav-tab flex flex-col items-center justify-center min-w-[80px] h-12 rounded-full transition-all duration-300 relative overflow-hidden active:scale-90',
            isActive(item.path)
              ? 'text-zinc-900 dark:text-zinc-100'
              : 'text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100'
          ]}
          aria-current={isActive(item.path) ? 'page' : undefined}
          aria-label={item.name}
          title={item.name}
        >
          {isActive(item.path) && (
            <div
              class="absolute inset-0 bg-zinc-100 dark:bg-zinc-800 -z-10 transition-all duration-300"
            />
          )}
          <item.icon class="w-5 h-5 mb-0.5" />
          <span class="text-[10px] font-medium leading-none">{item.name}</span>
        </a>
      ))}
    </div>
  </nav>

  <button
    id="back-to-top"
    class="pointer-events-auto w-14 h-14 flex items-center justify-center rounded-full bg-white/50 dark:bg-zinc-900/50 backdrop-blur-xl border border-zinc-200/50 dark:border-zinc-800/50 shadow-[0_8px_32px_rgba(0,0,0,0.12)] dark:shadow-[0_8px_32px_rgba(0,0,0,0.4)] text-zinc-500 dark:text-zinc-400 active:scale-90 transition-all duration-300 translate-x-10 opacity-0 scale-0 mb-[env(safe-area-inset-bottom)] cursor-pointer"
    aria-label="回到顶部"
  >
    <ArrowUpIcon class="w-5 h-5" />
  </button>
</div>

<script>
  function initNavFeatures() {
    const nav = document.getElementById('bottom-nav');
    const backToTopBtn = document.getElementById('back-to-top');

    if (!nav || !backToTopBtn) return;

    nav.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('.nav-tab') || target.closest('#back-to-top')) {
        if ('vibrate' in navigator) {
          navigator.vibrate(10);
        }
      }
    });

    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const handleScroll = () => {
      if (window.scrollY > 300) {
        backToTopBtn.classList.remove('translate-x-10', 'opacity-0', 'scale-0');
      } else {
        backToTopBtn.classList.add('translate-x-10', 'opacity-0', 'scale-0');
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll();
  }

  initNavFeatures();
  document.addEventListener('astro:after-swap', initNavFeatures);
</script>
